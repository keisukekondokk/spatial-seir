---
title: "Code and Data: <br>Simulating the Impacts of Interregional Mobility Restriction on the Spatial Spread of COVID-19 in Japan"
author: "Kondo Keisuke"
date: "`r format(Sys.time(), '%Y/%m/%d')`"
abstract: "This study develops a spatial Susceptible–Exposed–Infectious–Recovered (SEIR) model that analyzes the effect of interregional mobility on the spatial spread of the coronavirus disease 2019 (COVID-19) outbreak in Japan. National and local governments have requested that residents refrain from traveling between 47 prefectures during the state of emergency. However, the extent to which restricting the interregional mobility prevents infection expansion has not been elucidated. Our spatial SEIR model describes the spatial spread pattern of COVID-19 when people commute to a prefecture where they work or study during the daytime and return to their residential prefecture at night. We assume that people are exposed to infection risk during their daytime activities. According to our simulation results, interregional mobility restriction can prevent geographical expansion of the infection. However, in prefectures with many infectious individuals, residents are exposed to higher infection risk when their mobility is restricted. Our simulation results also show that interregional mobility restriction plays a limited role in reducing the national total number of infected individuals."
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
    number_sections: TRUE
    highlight: breezedark
---

<style>
img { float: left; }
</style>

```{r knitr_option, include=FALSE}
knitr::opts_chunk$set(cache = TRUE, results="hide", message=FALSE, warning=FALSE)
```


<div class="alert alert-info">
Kondo, K. "<b>Simulating the Impacts of Interregional Mobility Restriction on the Spatial Spread of COVID-19 in Japan,</b>" Preprint at medRxiv. (2020) <br>
https://doi.org/10.1101/2020.12.28.20248926
</div>


This document provides replication codes and data used in the simulation analysis. Simulation was conducted on the following environment:

- R (Version 4.0.2)
- RStudio (Version 1.3.1073)


# R Packages

This study uses the following R packages, which must be installed before running the R code.

```{r include_packages}
#from Github
if(!require(devtools)) install.packages("devtools")
#GRAPH
if(!require(ggplot2)) install.packages("ggplot2")
if(!require(ggrepel)) install.packages("ggrepel")
if(!require(scales)) install.packages("scales")
if(!require(patchwork)) devtools::install_github("thomasp85/patchwork")
if(!require(RColorBrewer)) install.packages("RColorBrewer")
#Dataframe
if(!require(tidyverse)) install.packages("tidyverse")
if(!require(readxl)) install.packages("readxl")
#Loop
if(!require(parallel)) install.packages("parallel")
if(!require(doParallel)) install.packages("doParallel")
if(!require(foreach)) install.packages("foreach")
#Shapefile
if(!require(sf)) install.packages("sf")
#Map Visualization
if(!require(tmap)) install.packages("tmap")
```


# Parameter settings in the simulation

In this study, the degree of NPIs was exogenously given by the parameter $\alpha(t)$ as a future policy target parameter, and six case scenarios were simulated: 

<div class="alert alert-secondary">
1. This is the <b>rapid convergence case scenario</b> at the early stage with <i><b>time-constant transmission rate</b> $\beta(t)$</i> in each month. The simulation starts from <b>April 7, 2020</b>.
1. This is the <b>modest convergence case scenario</b> in which convergence and divergence repeat with <i><b>time-varying transmission rate</b> $\beta(t)$</i> in each month. The simulation starts from <b>April 7, 2020</b>.
1. This is the <b>modest convergence case scenario</b> in which convergence and divergence repeat with <i><b>time-varying transmission rate</b> $\beta(t)$</i> in each month. The simulation starts from <b>August 17, 2020</b>.
1. This is the <b>modest convergence case scenario</b> in which convergence and divergence repeat with <i><b>time-varying transmission rate</b> $\beta(t)$</i> in each month. The simulation starts from <b>November 4, 2020</b>.
1. This is the <b>worsening case scenario</b> in which convergence and divergence repeat with <i><b>time-varying transmission rate</b> $\beta(t)$</i> in each month. The simulation starts from <b>November 4, 2020</b>.
1. This is the <b>mobility restriction only for Tokyo</b> and the <b>modest convergence case scenario</b> in which convergence and divergence repeat with <i><b>time-varying transmission rate</b> $\beta(t)$</i> in each month. The simulation starts from <b>November 4, 2020</b>.
</div>

Choose one of the scenarios in the code chunk (e.g., `numCaseScenario <- 4L`).

We assume that average incubation and infectious periods $\ell_\varepsilon$ and $\ell_\gamma$ were assumed as 5 days and 10 days, respectively. The infectiousness probability of an exposed individual was given as $\varepsilon = 1/\ell_\varepsilon$, and the recovery probability of an infected individual was given by $\gamma = 1/\ell_\gamma$. The transmission rate was determined as $\beta = \mathcal{R}_0 \gamma$ based on the standard SEIR model. The basic reproduction number $\mathcal{R}_0$ was set to 2.6, close to that obtained by other studies in Japan. These parameter settings were common to all simulation scenarios except the intervention degree of non-pharmaceutical interventions (NPIs) $\alpha(t)$. 

The degree of NPIs is loaded from the `data/parameter` directory, in which there are CSV files that determine the degrees of NPIs in each scenario.

```{r setting_parameters}
#-----------------------------------
#Choose Case Scenario (1L to 6L)
numCaseScenario <- 4L
#-----------------------------------

#Basic Reproduction Number
R0 <- 2.6
#Average Incubation Period (day)
l_epsilon <- 5
#Average Infectious Period (day)
l_gamma <- 10
#Incubation Rate
epsilon <- 1 / l_epsilon
#Recovery Rate
gamma <- 1 / l_gamma
#Transmission Rate
beta0 <- R0 * gamma
#NPIs Degree
listFiles <- list.files("data/parameter", pattern = ".csv", full.names = TRUE)
listAlpha <- lapply(listFiles, read_csv)
```


The simulation start date is set in the `r/spatial_seir_set_date.R`. It is possible to change the start date of simulation.

```{r setting_date}
#Date Setting for Simulation
source("r/spatial_seir_set_date.R", echo = TRUE, prompt.echo = "", spaced = FALSE)
```

The dataset for simulation is created by the `r/spatial_seir_make_data.R`.  

```{r make_dataset}
#Load and Make Dataset for Simulation
source("r/spatial_seir_load_data.R", echo = TRUE, prompt.echo = "", spaced = FALSE)
source("r/spatial_seir_make_data.R", echo = TRUE, prompt.echo = "", spaced = FALSE)
```

# Simulation

This code chunk makes folders to store simulation results.

```{r make_folders_to_store_results}
#Make Folders to Store Results
source("r/spatial_seir_make_folders_to_store_results.R", echo = TRUE, prompt.echo = "", spaced = FALSE)
```


This code chunk simulates the spatial SEIR model with and without interregional mobility.

```{r do_simulation}
#Call Function
source("r/spatial_seir_function_simulation.R", echo = TRUE, prompt.echo = "", spaced = FALSE)

#Do Simulation
listSimulationCaseScenario <- list(c(1, numCaseScenario), c(2, numCaseScenario))
listSimulationResults <- mclapply(listSimulationCaseScenario, fSimulation)

#Save Results
source("r/spatial_seir_save_results.R", echo = TRUE, prompt.echo = "", spaced = FALSE)
```


# Figures of Simulation Results

This code chunk creates figures of simulation results. Open `output/fig` directory.

```{r make_figure, results="hide"}
#Set DataFrame from Simulation Results
dfResultsLong1 <- listSimulationResults[[1]]
dfResultsLong2 <- listSimulationResults[[2]]

#Set End Day in Figure
#endDayFigure <- as.Date("2022-03-31", "%Y-%m-%d")
endDayFigure <- endDay

#Make Figures
source("r/spatial_seir_make_figure_I.R", echo = TRUE, prompt.echo = "", spaced = FALSE)
source("r/spatial_seir_make_figure_dI.R", echo = TRUE, prompt.echo = "", spaced = FALSE)
source("r/spatial_seir_make_figure_E.R", echo = TRUE, prompt.echo = "", spaced = FALSE)
source("r/spatial_seir_make_figure_S.R", echo = TRUE, prompt.echo = "", spaced = FALSE)
source("r/spatial_seir_make_figure_R.R", echo = TRUE, prompt.echo = "", spaced = FALSE)
source("r/spatial_seir_make_figure_ratiolambda.R", echo = TRUE, prompt.echo = "", spaced = FALSE)
source("r/spatial_seir_make_figure_beta.R", echo = TRUE, prompt.echo = "", spaced = FALSE)
source("r/spatial_seir_make_figure_alpha.R", echo = TRUE, prompt.echo = "", spaced = FALSE)
source("r/spatial_seir_make_figure_gapI.R", echo = TRUE, prompt.echo = "", spaced = FALSE)
source("r/spatial_seir_make_figure_gapdI.R", echo = TRUE, prompt.echo = "", spaced = FALSE)
```


# Figures of Simulation Results for Manuscript

This code chunk creates figures of simulation results used in the manuscript. Open `output/fig` directory.

```{r make_figure_from_SEIR_for_paper, results="hide"}
#Set DataFrame from Simulation Results
dfResultsLong1 <- listSimulationResults[[1]]
dfResultsLong2 <- listSimulationResults[[2]]

#Set End Day in Figure
#endDayFigure <- as.Date("2022-03-31", "%Y-%m-%d")
endDayFigure <- endDay

#Make Figures
source("r/spatial_seir_make_figure_I_paper.R", echo = TRUE, prompt.echo = "", spaced = FALSE)
source("r/spatial_seir_make_figure_ratiolambda_paper.R", echo = TRUE, prompt.echo = "", spaced = FALSE)
source("r/spatial_seir_make_figure_alpha_paper.R", echo = TRUE, prompt.echo = "", spaced = FALSE)
```
